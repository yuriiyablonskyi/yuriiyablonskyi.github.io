(window||this).bubbleText=function(e){if(e!==Object(e)||e.map===[].map)throw"bubbleText: Missing properties";var t=$(e.element),n=t[0];if(!n)throw"bubbleText: Missing element";if(t.find(":first").length)throw"bubbleText: Element must be one leaf node";var i=e.newText;if("string"!=typeof i)throw"bubbleText: Missing newText";var r=n.innerHTML,a={position:"relative",float:"left",overflow:"hidden"},l=$("<span>. .</span>").appendTo(t).css(a);function o(e){for(var n=[],i=0,r=e.length;i<r;i++){var a=e.charAt(i);n[i]={char:a,html:$('<span class="span-bubble-text">'+a+"</span>").appendTo(t)}," "===a&&n[i].html.width(l)}return n}l=l.width()-2*l.html(".").width(),n.innerHTML="";for(var h=o(i),s=o(r),p=[];h.length;){var f=h.shift(),d={add:f,width:f.html.width()+"px"};f.html.width(0);for(var c=f.char,v=0,b=s.length;v<b;v++)if(c===s[v].char){d.remove=s.splice(v,1)[0];break}p.push(d)}var m=0;if(e.hasOwnProperty("proportional")||(e.proportional=!0),e.proportional){var u=s.length,g=p.length;for(u>g?(u=Math.ceil(u/g),g=1):(g=Math.ceil(g/u),u=1);s.length;)if(m<p.length){for(var w=s.splice(0,u);w.length;)p.splice(m,0,{remove:w.shift()}),m++;m+=g}else p.push({remove:s.shift()})}else for(;s.length;){d={remove:s.shift()};m<p.length?(p.splice(m,0,d),m+=2):p.push(d)}var T=t.find("span"),x=t.css("line-height");a.height=/\d/.test(x)?x:$(T[0]).height()+"px",T.css(a);var M=parseInt(e.letterSpeed)||Math.floor((e.speed||2e3)/p.length),H=[" ",".",",","-"];return e.stop=function(){t.find("span").stop()},e.finish=function(t){e.stop(),n.innerHTML=i,t&&"function"==typeof e.callback&&e.callback()},e.restart=function(){e.stop(),n.innerHTML=r,$.extend(e,bubbleText(e))},function t(n){var i=p[n];if(!i)return e.finish(!0),void(e.repeat--&&setTimeout(e.restart,e.timeBetweenRepeat||1500));var r=function(){t(n+1)},a={duration:M,complete:r,easing:"linear"};if(i.add){var l=i.add.html;a.complete=function(){var e=" "===l.html();e||l.css("width","auto");var t=l.prev("span");if(t.length&&t.offset().top!==l.offset().top)if(e)l.replaceWith('<br clear="all">');else{for(;-1===H.indexOf(t.html())&&0!==(t=t.prev("span")).length;);t.after('<br clear="all">')}r()},l.animate({width:i.width},a)}i.remove&&i.remove.html.animate({width:0},i.add?{duration:M,easing:"linear"}:a)}(0),e};